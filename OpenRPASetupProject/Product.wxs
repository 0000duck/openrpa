<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <!-- Full version number to display -->
  <?define VersionNumber="!(bind.FileVersion.openrpaExe)" ?>
<!--<?define VersionNumber="1.0.89" ?>-->
  <!--
   Upgrade code HAS to be the same for all updates.
   Once you've chosen it don't change it.
   -->
  <?define UpgradeCode="c3ca861f-6a0c-40ad-b62d-ef94b84256ec" ?>

  <!-- The URL for add/remove programs -->
  <?define InfoURL="https://openrpa.dk/" ?>
  
  <!--<File Source="$(var.uberAgentExeSourcePath)" Id="uberAgentExe" KeyPath="yes" />-->

  <?define Win64 = "yes" ?>

  
  <!-- 32-bit / 64-bit variables -->
  <?if $(var.Platform) = x64 ?>
  <?define Win64 = "yes" ?>
  <?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
  <?define openrpaExeSourcePath = "$(var.ProjectDir)..\OpenRPA\bin\PrepInstaller\net462\OpenRPA.exe" ?>
  <?else ?>
  <?define Win64 = "no" ?>
  <?define PlatformProgramFilesFolder = "ProgramFilesFolder" ?>
  <?define openrpaExeSourcePath = "$(var.ProjectDir)..\OpenRPA\bin\PrepInstaller\net462\OpenRPA.exe" ?>
  <?endif ?>
  <Product Id="*" Name="!(loc.ApplicationName)" Language="!(loc.Language)" Version="$(var.VersionNumber)" Manufacturer="!(loc.ManufacturerFullName)" UpgradeCode="$(var.UpgradeCode)" >
		<Package InstallerVersion="200" Compressed="yes"  Platform="x64" InstallScope="perMachine" />
    <!-- InstallScope="perMachine" -->

		<MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
		<MediaTemplate EmbedCab="yes" />

    <Icon Id="open_rpa.ico" SourceFile="open_rpa.ico"/>
    <Property Id="ARPPRODUCTICON" Value="open_rpa.ico" />


    <Property Id="INSTALLMYFEATURE" Value="FALSE" />

    <WixVariable Id="MySource" Overridable="yes" Value="c:\Code\OpenRPA\OpenRPA\bin\PrepInstaller\net462"/>

    <Feature Id="MainFeature" Title="OpenRPA Core Components" Level="1" Absent='disallow' AllowAdvertise='no' ConfigurableDirectory='INSTALLDIR' >
      <!--  Display="hidden" -->
      <ComponentGroupRef Id="MainComponents" />
      <!--<ComponentGroupRef Id="MainComponentFiles" />-->
    </Feature>
    <!--<Feature Id="OfficeFeature" Title="Microsoft Office Integration" Level="1" Absent='allow' AllowAdvertise='yes' ConfigurableDirectory='INSTALLDIR' >
      <ComponentGroupRef Id="OfficeComponents" />
      <Condition Level='0'>HASEXCEL = "YES"</Condition>
    </Feature>-->
    <Feature Id="OfficeFeature" Title="Microsoft Office Integration" Level="1" Absent='allow' AllowAdvertise='yes' ConfigurableDirectory='INSTALLDIR' >
      <Condition Level="0"><![CDATA[NOT(INSTALLMYFEATURE~="TRUE")]]></Condition>
      <ComponentGroupRef Id="OfficeComponents" />
    </Feature>



    <!--<Property Id="ALLUSERS" Value="2" />-->
    <!--<Property Id="InstallFolder" Value="0" />
    <Property Id='ALLUSERS' Value='2' />
    <Property Id='MSIINSTALLPERUSER' Value='1' />-->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />

    <UIRef Id="UI_OPENRPA" />

    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="$(var.UpgradeCode)" Feature="MainFeature">
        <Shortcut Id="ApplicationStartMenuShortcut"
                  Name="OpenRPA"
                  Description="OpenRPA"
                  Target="[#openrpaExe]"
                  WorkingDirectory="APPLICATIONROOTDIRECTORY"/>
        <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall"/>
        <RegistryValue Root="HKCU" Key="Software\OpenRPA" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </DirectoryRef>


    <!--<InstallExecuteSequence>
      <Custom Action='HasExcel'  Before='InstallInitialize' >NOT Installed</Custom>
    </InstallExecuteSequence>-->


    <CustomAction Id="test_command2" Script="vbscript">
      <![CDATA[          
          MsgBox(Session.Property("INSTALLMYFEATURE"))
      ]]>
    </CustomAction>
    <InstallUISequence>
      <Custom Action='HasExcel'  Before='CostFinalize' >NOT Installed</Custom>
      <Custom Action="test_command2" After="HasExcel">NOT Installed</Custom>
    </InstallUISequence>
  </Product>

  <Fragment>
    <!-- AppSearch -->
    <Binary Id="HasExcelBinary" SourceFile="$(var.CheckForOffice.TargetDir)$(var.CheckForOffice.TargetName).CA.dll"/>
    <CustomAction Id="HasExcel" BinaryKey="HasExcelBinary" DllEntry="HasExcel" Execute="immediate" Return="check"/>
  </Fragment>
  
	<Fragment>
		<Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="LocalAppDataFolder">
        <!--<Directory Id="INSTALLDIR2" Name="OpenRPA" />-->
        <!--<Component Id="MainFeature" Guid="*">
        </Component>-->

      </Directory>
			<Directory Id="ProgramFiles64Folder">
				<Directory Id="INSTALLDIR" Name="OpenRPA" />
			</Directory>

      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="OpenRPA"/>
      </Directory>
    </Directory>

    
	</Fragment>

  
  


</Wix>
